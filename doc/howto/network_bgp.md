---
discourse: 11567
---

(network-bgp)=
# LXD を BGP サーバとして設定するには

```{note}
BGP サーバ機能は　{ref}`network-bridge` と {ref}`network-physical` で利用できます。
```

```{youtube} https://www.youtube.com/watch?v=C9zU-FEqtTw
```

{abbr}`BGP (Border Gateway Protocol)` は自律システム間でルーティング情報を交換できるプロトコルです。

外部アドレスを特定の LXD サーバやインスタンスに直接ルーティングしたい場合は、 LXD を BGP サーバとして設定できます。
すると LXD は BGP ピアとして振る舞い、関連するルートとネクストホップを外部のルータ、例えばあなたのネットワークルータに広告します。
アップストリームの BGP ルータとセッションを自動的に確立し、使用中のアドレスとサブネットを広告します。

BGP サーバ機能は LXD サーバやクラスタが正しいホストへルーティングされる特定のサブネットやアドレスを取得することで内部／外部アドレス空間を直接使用できるようにします。
こうすることで、トラフィックを対象のインスタンスにフォワードできます。

ブリッジネットワークについては、以下のアドレスとネットワークが広告されます。

- `ipv4.address` または `ipv6.address` サブネットのネットワーク (対応する `nat` プロパティが `true` に設定されていない場合)
- `ipv4.nat.address` または `ipv6.nat.address` サブネットのネットワーク (対応する `nat` プロパティが `true` に設定されていない場合)
- ネットワークフォワードアドレス
- ブリッジネットワークに接続されているインスタンス NIC 上の `ipv4.routes.external` または `ipv6.routes.external` で指定されているアドレスまたはサブネット

サブネットを対応する設定オプションに確実に追加してください。
さもなければ、広告されません。

物理ネットワークについては、物理ネットワークのレベルに直接広告されるアドレスはありません。
代わりに、全てのダウンストリームネットワーク (`network` オプションで物理ネットワークをアップリンクネットワークとして指定するネットワーク) のネットワーク、フォワードとルートがブリッジネットワークに対するのと同じように広告されます。

```{note}
現時点では、特定のピアに一部の特定のルート／アドレスのみを広告することはできません。
これが必要な場合はアップストリームルータでプリフィクスをフィルタしてください。
```

## BGP サーバを設定する

LXD を BGP サーバとして設定するには、以下のサーバ設定オプションを全てのクラスタメンバで設定してください ({ref}`server` 参照)。

- `core.bgp_address` - BGP サーバの IP アドレス
- `core.bgp_asn` - ローカルサーバの {abbr}`ASN (Autonomous System Number)`
- `core.bgp_routerid` - BGP サーバのユニークな識別子

例えば、以下のような値を設定します。

```bash
lxc config set core.bgp_address=192.0.2.50:179
lxc config set core.bgp_asn=65536
lxc config set core.bgp_routerid=192.0.2.50
```

これらの設定オプションが一旦設定されると、 LXD は BGP セッションのリッスンを始めます。

### ネクストホップを設定する (`bridge` のみ)

ブリッジネットワークについては、ネクストホップ設定をオーバーライドできます。
デフォルトでは、ネクストホップは BGP セッションに使用されるアドレスに設定されます。

別のアドレスに設定するには、 `bgp.ipv4.nexthop` または `bgp.ipv6.nexthop` を設定してください。

### OVN ネットワークに BGP ピアを設定する

OVN ネットワークをアップリンクネットワーク (`physical` または `bridge`) と使用する場合、アップリンクネットワークは許可されるサブネット一覧と BGP 設定を持つネットワークです。
このため、 BGP サーバに接続するのに必要な情報を含むアップリンクネットワーク上に BGP ピアを設定する必要があります。

アップリンクネットワークに対して以下の設定オプションを設定してください。

- `bgp.peers.<name>.address` - ダウンストリームネットワークで使用されるピアアドレス
- `bgp.peers.<name>.asn` - ローカルサーバの {abbr}`ASN (Autonomous System Number)`
- `bgp.peers.<name>.password` - ピアセッションに対するオプショナルなパスワード
- `bgp.peers.<name>.holdtime` - ピアセッションに対する省略可能なホールドタイム (秒で指定)

アップリンクネットワークが一旦設定されると、ダウンストリームの OVN ネットワークは BGP で広告される外部のサブネットとアドレスを取得します。
ネクストホップはアップリンクネットワークの OVN ルータのアドレスに設定されます。
