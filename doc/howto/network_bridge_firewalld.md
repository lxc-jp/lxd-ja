(network-bridge-firewalld)=
# Firewalld を設定するには

## Firewalld で DHCP, DNS を許可する

firewalld を使用する際に LXD が動いているホストの DHCP と DNS サーバにインスタンスがアクセスできるようにするために
firewalld の `trusted` ゾーンにホストのブリッジインタフェースを追加する必要があります。

これを恒久的に行い (リブート後にも残るようにするには) 以下のコマンドを実行します。

```
firewall-cmd --zone=trusted --change-interface=<LXD network name> --permanent
```

例えば、 `lxdbr0` というブリッジネットワークには以下のコマンドを実行します。

```
firewall-cmd --zone=trusted --change-interface=lxdbr0 --permanent
```

これにより LXD 自身のファイアウォールルールが有効になります。


## Firewalld に LXD の iptables ルールを制御させるには

firewalld と LXD を一緒に使う場合、 iptables のルールがオーバーラップすることがあります。例えば firewalld が LXD デーモンより後に起動した場合、 LXD の iptables のルールを消してしまうことがあり、すると LXD コンテナが外向きのインターネットアクセスができなくなってしまいます。
これを修正する 1 つの方法は firewalld に LXD の iptables ルールを移譲し LXD のほうを無効化することです。

最初のステップは [DNS と DHCP を許可する](#allow-dhcp-dns-with-firewalld) ことです。

次に LXD に iptables ルールの設定を完全に停止します (firewalld が代わりに行うので)。
```
lxc network set lxdbr0 ipv4.nat false
lxc network set lxdbr0 ipv6.nat false
lxc network set lxdbr0 ipv6.firewall false
lxc network set lxdbr0 ipv4.firewall false
```

最後に iptables の firewalld のルールを LXD のユースケース (この例では、ブリッジインタフェースは `lxdbr0` で関連する IP の範囲は `10.0.0.0/24` であると想定しています) 用に有効にします。
```
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -i lxdbr0 -s 10.0.0.0/24 -m comment --comment "generated by firewalld for LXD" -j ACCEPT
firewall-cmd --permanent --direct --add-rule ipv4 filter OUTPUT 0 -o lxdbr0 -d 10.0.0.0/24 -m comment --comment "generated by firewalld for LXD" -j ACCEPT
firewall-cmd --permanent --direct --add-rule ipv4 filter FORWARD 0 -i lxdbr0 -s 10.0.0.0/24 -m comment --comment "generated by firewalld for LXD" -j ACCEPT
firewall-cmd --permanent --direct --add-rule ipv4 nat POSTROUTING 0 -s 10.0.0.0/24 ! -d 10.0.0.0/24 -m comment --comment "generated by firewalld for LXD" -j MASQUERADE
firewall-cmd --reload
```
ルールが firewalld に設定されているか確認するには以下のようにします。
```
firewall-cmd --direct --get-all-rules
```

警告: 上記の手順は絶対確実なアプローチではなく、ついうっかりセキュリティリスクを取り込んでしまう可能性があります。
