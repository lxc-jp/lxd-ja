# ストレージドライバ

```{toctree}
:maxdepth: 1

storage_dir
storage_ceph
storage_cephfs
storage_btrfs
storage_lvm
storage_zfs
```

## 機能比較
LXD では、イメージ、インスタンス、カスタムボリューム用のストレージとして ZFS、btrfs、LVM、単なるディレクトリが使えます。
可能であれば、各システムの高度な機能を使って、LXD は操作を最適化しようとします。

機能                                               | ディレクトリ | Btrfs | LVM  | ZFS  | Ceph | CephFS
:---                                               | :---         | :---  | :--- | :--- | :--- | :---
最適化されたイメージストレージ                     | no           | yes   | yes  | yes  | yes  | n/a
最適化されたインスタンスの作成                     | no           | yes   | yes  | yes  | yes  | n/a
最適化されたスナップショットの作成                 | no           | yes   | yes  | yes  | yes  | yes
最適化されたイメージの転送                         | no           | yes   | no   | yes  | yes  | n/a
最適化されたインスタンスの転送                     | no           | yes   | no   | yes  | yes  | n/a
コピーオンライト                                   | no           | yes   | yes  | yes  | yes  | yes
ブロックデバイスベース                             | no           | no    | yes  | no   | yes  | no
インスタントクローン                               | no           | yes   | yes  | yes  | yes  | yes
コンテナ内でストレージドライバの使用               | yes          | yes   | no   | no   | no   | n/a
古い（最新ではない）スナップショットからのリストア | yes          | yes   | yes  | no   | yes  | yes
ストレージクオータ                                 | yes(\*)      | yes   | yes  | yes  | yes  | yes

## おすすめのセットアップ
LXD から使う場合のベストなオプションは ZFS と btrfs を使うことです。
このふたつは同様の機能を持ちますが、お使いのプラットフォームで使えるのであれば、ZFS のほうがより信頼性が上です。

可能であれば、LXD のストレージプールにディスクかパーティション全体を与えるのが良いでしょう。
LXD で loop ベースのストレージを作れますが、プロダクション環境ではおすすめしません。

同様に、ディレクトリバックエンドも最後の手段として考えるべきでしょう。
LXD の主な機能すべてが使えますが、インスタントコピーやスナップショットが使えないので、毎回インスタンスのストレージ全体をコピーする必要があり、恐ろしく遅くて役に立たないでしょう。

## セキュリティの考慮

現在、 Linux Kernel はブロックベースのファイルシステム（例: `ext4`）が別のオプションでマウント済みの場合マウントオプションは適用せずに黙って無視します。
これは専用ディスクデバイスが異なるストレージプール間で共有されている時、2つめのマウントは期待しているマウントオプションが設定されないかもしれないことを意味します。
これは例えば1つめのストレージプールが `acl` サポートを提供する想定で、2つめのストレージプールが `acl` サポートを提供しない想定であるようなときにセキュリティ上の問題になります。
この理由により、現状はストレージプールごとに専用のディスクデバイスを持つか、同じ専用ディスクを共有する全てのストレージプールで同じマウントオプションを使うことを推奨します。

## 最適化されたイメージストレージ
ディレクトリ以外のすべてのバックエンドには、ある種の最適化されたイメージ格納フォーマットがあります。
これは、一からイメージの tarball を展開するのではなく、あらかじめ作られたイメージボリュームから単にクローンして、瞬間的にインスタンスを作るのに使われます。

そのイメージで使えないストレージプールの上にそのようなボリュームを準備することは無駄なので、ボリュームはオンデマンドで作成されます。
したがって、最初のインスタンスはあとで作るインスタンスよりは作成に時間がかかります。

## 最適化されたインスタンスの転送
ZFS、btrfs、Ceph RBD は内部で send/receive メカニズムを持っており、最適化されたボリュームの転送ができます。
LXD はこのような機能を使い、サーバ間でインスタンスやスナップショットを転送します。

ストレージドライバーがこのような機能をサポートしていない場合や、転送元と転送先のサーバのストレージバックエンドが違う場合で、このような機能が使えない場合は、
LXD は代わりに rsync を使った転送にフォールバックし、個々のファイルを転送します。

rsync を使う必要がある場合、LXD ではストレージプールのプロパティである `rsync.bwlimit` を 0 以外の値に設定することで、ソケット I/O の流量の上限を設定できます。

## I/O 制限
ストレージデバイスをインスタンスにアタッチする際に、IOPS や MB/s による I/O 制限を、ストレージデバイスに対して設定できます（詳しくは [インスタンス](instances.md) をご覧ください）。

この制限は Linux の `blkio` cgroup コントローラーを使って適用します。ディスクレベルで I/O の制限ができます（それより粒度の細かい制限はできません）。

この制限は、パーティションやパスではなく、全物理ディスクに対して適用されるので、次のような制限があります:

 - 制限は仮想デバイス（例えば device mapper）によって実現しているファイルシステムには適用されません
 - 複数のブロックデバイス上に存在するファイルシステムの場合、それぞれのデバイスは同じ制限が適用されます
 - 同じディスク上に存在するふたつのディスクデバイスをインスタンスに与えた場合、ふたつのデバイスの制限は平均化されます

すべての I/O 制限は、実際のブロックデバイスにのみ適用されるので、制限を設定する際には、ファイルシステム自身のオーバーヘッドを考慮する必要があるでしょう。
このことは、キャッシュされたデータへのアクセスは、制限の影響を受けないことも意味します。
